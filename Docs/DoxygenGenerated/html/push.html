<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CotC C# SDK for Unity: Push Notification</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="OutputCustomization.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="xtralife-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CotC C# SDK for Unity
   &#160;<span id="projectnumber">v1.4.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Push Notification </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Push notifications (not to be confused with <a class="el" href="class_cotc_sdk_1_1_push_notification.html">the PushNotification class</a>) are provided with the push notification package, which may be downloaded separately.</p>
<p>Additionally, push notifications require server side configuration. This documentation will describe how to set it up like any mobile application, and then how to integrate the SDK. We recommend that you perform the former steps first, since the changes made to the configuration on Google/Apple sides need some delay to take effect.</p>
<h2>Table of Contents</h2>
<ol type="1">
<li><a href="#toc_push_1">Push Notification for iOS</a></li>
<li><a href="#toc_push_2">Push Notification for Android</a></li>
</ol>
<hr/>
<h1><a class="anchor" id="toc_push_1"></a>
Setup Notifications for iOS</h1>
<p>On iOS, push notifications use the Apple Push Notification Service, which we'll describe how to set up in the following paragraphs.</p>
<p>First, set up a certificate with Push notifications enabled on the <a href="http://developer.apple.com/">Apple Developer Center</a> </p><div class="image">
<img src="ios-push-1.png" alt="ios-push-1.png"/>
<div class="caption">
Create Certificate</div></div>
<p> Download it, </p><div class="image">
<img src="ios-push-2.png" alt="ios-push-2.png"/>
<div class="caption">
Download Certificate</div></div>
<p> and convert it to .pem format with the following command: </p><div class="fragment"><div class="line">openssl x509 -in certificate.cer -inform DER -outform PEM -out certificat-aps-dev</div></div><!-- fragment --><p>You'll also need to convert the <b>private</b> key used to generate this certificate to the .pem format. To do this, you first need to export your private key to p12 format by using the Keychain Access tool on your Mac. Launch Keychain Access and right click on the certificate that you have just downloaded and installed, and select the "Export" option, and then the .p12 format. </p><div class="image">
<img src="Keychain_Access.png" alt="Keychain_Access.png"/>
<div class="caption">
Export your private key</div></div>
<p>Once this is done, just convert your private key to .pem format with the following command: </p><div class="fragment"><div class="line">openssl pkcs12 -in private_push_key.p12 -out push-key-dev.pem -nodes</div></div><!-- fragment --><p>Once you've got your two .pem files, open a web page to our <a href="https://account.clanofthecloud.com">Back Office</a>, tick the iOS box inside the the "Push Notification Certificates" in your Status page, and fill respectively the "Certificate" and "Private Key" cells with the contents of the files you just created at the previous step (see above). </p><div class="image">
<img src="CotC_iOS_PushNotifs.png" alt="CotC_iOS_PushNotifs.png"/>
<div class="caption">
Setting up your iOS push notifications with Clan of the Cloud back office</div></div>
<p>Then, you simply have to import the Cotc.PushNotifications package. When you build your application, check that you are using the provisioning profile for the application for which you enabled push notifications. Everything should be automatic with Xcode though.</p>
<p>Push notifications require no further configuration on your side. You should not even have to implement anything: just placing the <code>CotcPushNotificationsGameObject</code> on your scenes will ensure that everything works fine. It will transparently ask for push notifications permission upon login done with the main CotC SDK Game Object and register the device for push notifications. When a message has been delivered successfully (processed by the SDK, raised via <a class="el" href="class_cotc_sdk_1_1_domain_event_loop.html#af7a75c1c843136c1a92b20afc98e5170" title="This event is raised when an event is received.">CotcSdk.DomainEventLoop.ReceivedEvent</a>), the application badge is reseted.</p>
<hr/>
<h1><a class="anchor" id="toc_push_2"></a>
Setting up notifications for Android (GCM)</h1>
<p>In case you need some more information about how Google Cloud Messaging works, please have a look at the <a href="https://developer.android.com/google/gcm/gcm.html">official Google documentation</a>. Otherwise, by following the steps below, you should be able to have your application manage push notifications pretty quickly.</p>
<p>First, you need to setup a Google Application. Since this is changing quite rapidly at the time of writing, please follow the previous guide for information on how to do it. Once this is done, this Google Application needs to reference the Google Cloud Messaging for Android API. This is done from the APIs section of the Google Developer Console for your project. </p><div class="image">
<img src="Google_Messaging_Android.png" alt="Google_Messaging_Android.png"/>
<div class="caption">
Activating Google Cloud Messaging</div></div>
<p>In case you are using the new interface, it may look more like the following capture. In this case, when following the instructions above, follow the page <a href="https://developers.google.com/cloud-messaging/android/client">add Cloud Messaging to your existing app</a> and click on the button "Get a configuration file". Then you need to input information about your application (remember to sign in with your Google Developer account first). In the next screen you will obtain everything needed to set up GCM: the API key to set in the backoffice and the sender ID to set in the manifest. </p><div class="image">
<img src="CotC_Android_PushNotifs2.png" alt="CotC_Android_PushNotifs2.png"/>
<div class="caption">
Setting up Android push notifications with the newer Google Developer Console</div></div>
<p>Next step is to create a Public API key. To do so, select the Credentials section, just below the APIs section in the previous step, scroll down to the bottom of the page, and click the "Create new Key" button for the Public API access list of keys. Then select "Server key" option, and then "Create", not modifying anything. You should now have a new, valid API key. </p><div class="image">
<img src="Google_Public_API_Access.png" alt="Google_Public_API_Access.png"/>
<div class="caption">
Creating a new Server key</div></div>
<p>Once this is done, you're almost finished with parameterization, and only some bits of code will be needed. But first, you need to declare your Google Application with Clan of the Cloud through your <a href="https://account.clanofthecloud.com">Back Office web page</a>. Now it's straightforward. Just tick the Android box inside the "Push Notification Certificates" in your Status page, and fill the "senderID" cell with the Google Application project number, and the "apiKey" cell with the key you just created at the previous step (see above). </p><div class="image">
<img src="CotC_Android_PushNotifs1.png" alt="CotC_Android_PushNotifs1.png"/>
<div class="caption">
Setting up your Android push notifications with Clan of the Cloud back office</div></div>
<p>Now everything's been done on the Google Application side, we need to add a few snippets of code, so your application can communicate with the Google Cloud Messaging servers. First thing to modify is your AndroidManifest.xml, which is located under Assets/Plugins/Android.</p>
<p>Inside the <code>&lt;application&gt;</code> tag, make sure to have the following entries: </p><div class="fragment"><div class="line">&lt;meta-data android:name=&quot;cotc.GcmSenderId&quot; android:value=&quot;\ XXXXXXXXXX&quot; /&gt;</div><div class="line">&lt;meta-data android:name=&quot;cotc.GcmNotificationIcon&quot; android:resource=&quot;@drawable/ic_stat_ic_notification&quot; /&gt;</div><div class="line">&lt;meta-data android:name=&quot;cotc.GcmNotificationTitle&quot; android:value=&quot;Cotc sample&quot; /&gt;</div><div class="line"></div><div class="line">&lt;receiver</div><div class="line">    android:name=&quot;com.google.android.gms.gcm.GcmReceiver&quot;</div><div class="line">    android:exported=&quot;true&quot;</div><div class="line">    android:permission=&quot;com.google.android.c2dm.permission.SEND&quot; &gt;</div><div class="line">    &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name=&quot;com.google.android.c2dm.intent.RECEIVE&quot; /&gt;</div><div class="line">        &lt;category android:name=&quot;com.clanofthecloud.sampleunityproject&quot; /&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">&lt;/receiver&gt;</div></div><!-- fragment --><p>You need to change the following:</p>
<ul>
<li><code>&lt;category android:name="com.clanofthecloud.sampleunityproject" /&gt;</code> to the Bundle Identifier of your application (under Player Settings, Android, Identification).</li>
<li><code>&lt;meta-data android:name="cotc.GcmSenderId" android:value="\ XXXXXXXXXX" /&gt;</code> to the sender ID that you received when creating the application. Note that the first backslash + space are necessary, else the field will be interpreted as an integer and might overflow, breaking the application silently (if you spot an INVALID_PARAMETERS message in the log, double check that).</li>
<li><code>cotc.GcmNotificationIcon</code> node with the name of a resource to be used as icon.</li>
<li><code>cotc.GcmNotificationTitle</code> node with the name of your application.</li>
<li>If you are using facebook, you may need to remove <code>android-support-v4.jar</code> under Assets/Plugins/Android/Facebook/libs.</li>
</ul>
<p>Your application is now ready to receive push notifications from Google Cloud Messaging! No further configuration is required on your side: just placing the <code>CotcPushNotificationsGameObject</code> on your scenes will ensure that everything works fine. It will transparently register for notifications upon login done with the main CotC SDK Game Object. Notifications will be received via the standard GCM service (running in background on your device), that starts a small piece of code embedded in our SDK upon event, showing a notification using the parameters set in the manifest.</p>
<h2>Modifying the cotcinapppurchase plugin</h2>
<p>Depending on your needs, you may want to modify the cotcpushnotifications native plugin in order to get more control on what happens upon receiving a push notification. This plugin is supplied with the sources of the SDK under PlatformSpecific/Android/cotcpushnotifications, and the parent folder can simply be opened with Android Studio.</p>
<p>This project is basically constituted of four classes:</p>
<ul>
<li><b>Controller.java</b>: which you shouldn't change.</li>
<li><b>MyInstanceIDListenerService.java</b>: which you shouldn't change either.</li>
<li><b>RegistrationIntentService.java</b>: which you shouldn't change either.</li>
<li><b>MyGcmListenerService.java</b>: which is the most of interest.</li>
</ul>
<p>In MyGcmListenerService.java, in particular there are two methods of interest:</p>
<ul>
<li><code>onMessageReceived</code>: which is called by the system when a message is received (push notification),</li>
<li><code>sendNotification</code>: that creates an entry in the notification menu. You can modify this method in order to customize the sound that is played, the title and text of the notification and what happens when you click on the notification. In particular, the following code attaches the notification to the <code>UnityPlayerActivity</code> (if no activity is running; that is the notification was received while the application was not launched), or the currently active activity according to Unity. If you have customized the default Unity activity in the manifest, you should replace <code>activityToOpen</code> by the name of your main activity, since it is the one you want to open when starting the app as a result of clicking on a notification.</li>
</ul>
<div class="fragment"><div class="line">Activity currentAct = UnityPlayer.currentActivity;</div><div class="line">Class activityToOpen = currentAct != <span class="keyword">null</span> ? currentAct.getClass() : UnityPlayerActivity.class;</div><div class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, activityToOpen);</div></div><!-- fragment --><p>You can then recompile the plugin using the command <code>./gradlew build</code> on the root of the project (PlatformSpecific/Android). This will recompile both the in-app purchase and push notification plugins. The resulting AAR (under build/outputs/aar/) is then copied in the sample Unity project. If you want to customize that behavior and automatically copy it elsewhere, you can modify the <code>build.gradle</code> file under cotcpushnotifications.</p>
<div class="fragment"><div class="line">//task to delete the old jar</div><div class="line">task deleteOldJar(type: Delete) {</div><div class="line">    delete &#39;../../../UnityProject/Assets/Plugins/Android/Cotc.PushNotifications.aar&#39;</div><div class="line">}</div><div class="line"></div><div class="line">//task to export contents as jar</div><div class="line">task exportJar(type: Copy) {</div><div class="line">    from(&#39;build/outputs/aar/&#39;)</div><div class="line">    into(&#39;../../../UnityProject/Assets/Plugins/Android/&#39;)</div><div class="line">    include(&#39;cotcpushnotifications-release.aar&#39;)</div><div class="line">    // Rename the jar</div><div class="line">    rename(&#39;cotcpushnotifications-release.aar&#39;, &#39;Cotc.PushNotifications.aar&#39;)</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Mar 7 2019 12:39:54 for CotC C# SDK for Unity by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
